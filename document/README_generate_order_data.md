# 订单数据生成工具

## 功能说明

此脚本用于生成丰富、真实、多样化的订单测试数据，以充分验证 ADS 层的三个订单指标：

1. **历史被下单总件数最多的商品** - 生成90天历史订单，热门商品购买件数明显更高
2. **最近一周每个省份下单件数最多的商品** - 为每个省份注入特色热销商品
3. **每个省份下单商品数量前三的商品** - 确保每个省份都有明显的 Top3 排名

## 数据特点

### 1. 真实性

- 基于 `gmall.sql` 中的实际 SKU 商品信息
- 覆盖全部 34 个省份
- 时间跨度：最近 90 天 + 重点最近 7 天
- 订单状态、支付方式、优惠金额等符合业务逻辑

### 2. 多样性

- **热门商品**：小米手机、ThinkPad 笔记本、TCL 电视等，购买量大
- **普通商品**：相机、口红等，购买量适中
- **省份特色**：每个省份有自己的热销商品偏好
  - 北京/天津：小米手机系列
  - 上海/江苏：商务笔记本
  - 浙江/山东：电视
  - 甘肃/四川：美妆口红
  - 广东：手机中配版本

### 3. 层次性

- **历史数据**：90 天，每天 80-150 单，总计约 9000+ 订单
- **近期数据**：最近 7 天，每省每天 20-50 单特色商品，总计约 5000+ 订单
- **Top3 数据**：过去 30 天，为每省生成 Top3 商品明确排名，总计约 7000+ 订单

### 4. 可验证性

生成后自动显示统计信息：

- 订单总数、明细总数、商品总件数
- Top5 商品（历史总件数）
- 最近 7 天各省 Top1 商品示例
- 时间范围、涉及商品数、省份数等

## 使用方法

### 前置条件

1. 确保 MySQL 数据库已启动且包含 `gmall` 数据库
2. `config/config.ini` 中配置了正确的 MySQL 连接信息
3. 已导入 `assets/gmall.sql` 中的表结构和基础数据

### 运行脚本

```powershell
# 激活 conda 环境
conda activate pyspark310

# 运行数据生成脚本
python tools/generate_order_data.py
```

### 交互确认

脚本会提示：

```plaintext
⚠️  警告：此操作将清空现有的订单数据！
是否继续？(yes/no):
```

输入 `yes` 继续，输入 `no` 取消。

### 预期输出

```plaintext
==============================================================
GMALL订单数据生成工具
==============================================================

✓ 成功连接到MySQL数据库: gmall

开始清空现有订单数据...
  - 清空表: order_detail_coupon
  - 清空表: order_detail_activity
  - 清空表: order_detail
  - 清空表: order_status_log
  - 清空表: payment_info
  - 清空表: order_info
✓ 现有订单数据清空完成

==============================================================
开始生成测试数据
==============================================================

开始生成历史订单数据（90天）...
  - 已生成到 2025-08-10
  - 已生成到 2025-08-20
  ...
✓ 历史订单数据生成完成
  - 订单数: 9523
  - 订单明细数: 24831

开始生成最近一周的省份特色订单...
  - 已生成 2025-10-25 的省份特色订单
  - 已生成 2025-10-26 的省份特色订单
  ...
✓ 最近一周省份特色订单生成完成
  - 订单数: 7812
  - 订单明细数: 7812

开始生成各省Top3商品多样性数据...
  - 已生成前 5 个省份的Top3数据
  - 已生成前 10 个省份的Top3数据
  ...
✓ 各省Top3商品多样性数据生成完成
  - 订单数: 7140
  - 订单明细数: 7140

==============================================================
数据统计信息
==============================================================
订单总数: 24475
订单明细总数: 39783
商品总件数: 98562
涉及商品数: 19
涉及省份数: 34
时间范围: 2025-08-02 00:03:12 ~ 2025-10-31 23:58:47

Top5 商品（按历史总件数）:
  1. SKU#1 小米10 青春版 5G 6GB+64GB: 12458件
  2. SKU#2 小米10 青春版 5G 6GB+128GB: 8932件
  3. SKU#13 ThinkPad X1 Carbon i5-10210U 8G 512G: 6741件
  ...

最近7天各省Top1商品示例（前5个省份）:
  省份#1: SKU#1 小米10 青春版 5G 6GB+64GB - 1523件
  省份#2: SKU#3 小米10 青春版 5G 8GB+128GB - 1387件
  ...
==============================================================

✅ 数据生成完成！

接下来可以运行以下命令测试ADS指标：
  python hive.py dws_to_ads
或运行完整流水线：
  python main.py
```

## 生成策略详解

### 历史订单生成（90天）

- **目的**：为"历史被下单总件数最多的商品"指标提供充足数据
- **策略**：
  - 热门商品（前 8 个 SKU）出现概率 70%，购买件数 1-8
  - 普通商品出现概率 30%，购买件数 1-3
  - 每天 80-150 单，总计约 9000+ 单
- **结果**：热门商品总件数远超普通商品，Top1 商品明显

### 最近7天省份特色订单

- **目的**：为"最近一周各省份下单件数最多的商品"指标提供数据
- **策略**：
  - 为每个省份指定一个特色商品（模拟地区消费偏好）
  - 每省每天生成 20-50 单该特色商品订单
  - 购买件数 2-10，确保该商品在本省 7 天内遥遥领先
- **结果**：每个省份都有明确的 7 天内 Top1 商品

### 各省Top3多样性数据（30天）

- **目的**：为"每个省份下单商品数量前三"指标提供数据
- **策略**：
  - 为每个省份随机选择 3 个商品作为 Top3
  - Top1 商品生成 80-120 单，Top2 生成 50-79 单，Top3 生成 30-49 单
  - 分布在过去 30 天内
- **结果**：每个省份都有清晰的 Top3 排名，且排名差距明显

## 数据量估算

| 数据集 | 订单数 | 明细数 | 总件数 |
|--------|--------|--------|--------|
| 历史90天 | ~9,500 | ~25,000 | ~50,000 |
| 近7天省份特色 | ~7,800 | ~7,800 | ~40,000 |
| 各省Top3（30天） | ~7,100 | ~7,100 | ~25,000 |
| **总计** | **~24,500** | **~40,000** | **~115,000** |

## 后续步骤

生成数据后，可按以下步骤验证 ADS 指标：

```powershell
# 方式1：只运行 DWS -> ADS 步骤（假设其他层已有数据）
python hive.py dws_to_ads

# 方式2：运行完整流水线（从 MySQL 到 ADS）
python main.py

# 方式3：单独测试某个 ADS 指标
# 需要修改 hive_dws_to_ads.py 仅调用特定方法
```

## 常见问题

### Q1: 生成数据失败

**A**: 检查以下事项：

- MySQL 服务是否启动
- `config/config.ini` 中的 MySQL 配置是否正确
- 是否已导入 `gmall.sql` 的表结构
- Python 依赖 `mysql-connector-python` 是否已安装

### Q2: 数据量不足

**A**: 可以修改脚本参数：

- `generate_historical_orders(days=90, orders_per_day_range=(80, 150))` - 增加天数或每天订单数
- `orders_count = random.randint(20, 50)` - 增加省份特色订单数量
- `province_top3[province_id]` - 增加 Top3 商品的订单权重

### Q3: 如何重新生成

**A**: 直接再次运行脚本，选择 `yes` 确认清空即可。

### Q4: 生成时间过长

**A**: 正常情况下生成 2-3 万订单需要 30-60 秒。如果过慢：

- 检查 MySQL 性能
- 减少数据量参数
- 确保没有大量索引（order_info 表只需主键和必要索引）

## 扩展建议

如需更复杂的数据场景，可以：

1. **增加季节性波动**：在特定时段（如双11、618）增加订单量
2. **增加商品关联**：某些商品经常一起购买
3. **增加用户行为模式**：活跃用户购买频率更高
4. **增加价格波动**：商品价格随时间有促销变化
5. **增加退款数据**：生成 `order_refund_info` 表数据

## 注意事项

⚠️ **生产环境警告**：

- 此脚本仅用于测试环境
- 会清空现有订单数据，生产环境慎用
- 生成的订单 ID 从 1 开始，可能与现有数据冲突

✅ **最佳实践**：

- 在测试数据库上运行
- 生成后备份数据
- 验证 ADS 指标后再调整数据生成策略
